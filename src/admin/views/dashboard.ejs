<!-- Dashboard Header -->
<div class="mb-8">
  <h1 class="text-2xl font-semibold text-white">Dashboard</h1>
  <p class="text-gray-500 text-sm mt-1">Monitor your weekly airdrop distributions</p>
</div>

<!-- Config & Mode Indicators -->
<div class="bg-dark-700 border border-dark-500 rounded-xl p-5 mb-8">
  <div class="flex flex-wrap gap-6 items-center justify-between">
    <div class="flex items-center gap-6">
      <!-- Network -->
      <div>
        <span class="text-gray-500 text-xs uppercase block mb-1">Network</span>
        <span class="text-lg font-mono <%= isForkMode ? 'text-yellow-400' : 'text-cyan-400' %>">
          <%= network.name %>
        </span>
        <span class="text-gray-500 text-xs block">(Chain ID: <%= network.chainId %>)</span>
      </div>
      <!-- Minimum Balance -->
      <div>
        <span class="text-gray-500 text-xs uppercase block mb-1">Min Balance</span>
        <span class="text-lg font-mono text-white"><%= minBalance %> AQUARI</span>
      </div>
      <!-- Reward Token -->
      <div>
        <span class="text-gray-500 text-xs uppercase block mb-1">Reward Token</span>
        <span class="text-lg font-mono text-white"><%= rewardToken %></span>
      </div>
    </div>
    <!-- Mode Indicators -->
    <div class="flex items-center gap-3">
      <!-- Airdrop Mode -->
      <% if (isForkMode) { %>
      <span class="px-3 py-1 text-xs font-medium rounded-full bg-yellow-500/20 text-yellow-400 border border-yellow-500/30">
        FORK MODE
      </span>
      <% } else { %>
      <span class="px-3 py-1 text-xs font-medium rounded-full bg-emerald-500/20 text-emerald-400 border border-emerald-500/30">
        PRODUCTION
      </span>
      <% } %>
      <% if (mockSnapshots) { %>
      <span class="px-3 py-1 text-xs font-medium rounded-full bg-gray-500/20 text-gray-400 border border-gray-500/30">
        MOCK DATA
      </span>
      <% } %>
      <% if (mockTransactions) { %>
      <span class="px-3 py-1 text-xs font-medium rounded-full bg-purple-500/20 text-purple-400 border border-purple-500/30">
        SIMULATED TX
      </span>
      <% } else { %>
      <span class="px-3 py-1 text-xs font-medium rounded-full bg-red-500/20 text-red-400 border border-red-500/30 animate-pulse">
        LIVE TX
      </span>
      <% } %>
    </div>
  </div>

  <% if (schedule && schedule.useFastCycles) { %>
  <!-- Fork Mode Config -->
  <div class="mt-4 pt-4 border-t border-dark-600">
    <div class="flex flex-wrap gap-6 items-center justify-between">
      <div class="flex flex-wrap gap-6 items-center">
        <% if (schedule.snapshotCron || schedule.calculateCron) { %>
        <!-- Cron-based scheduling -->
        <div class="text-xs text-gray-500">
          <span class="font-medium text-gray-400">Cron Schedule:</span>
          <% if (schedule.snapshotCron) { %>
          Snapshot <span class="text-cyan-400 font-mono"><%= schedule.snapshotCron %></span>
          <% } %>
          <% if (schedule.calculateCron) { %>
          â†’ Calculate <span class="text-emerald-400 font-mono"><%= schedule.calculateCron %></span>
          <% } %>
          â†’ <span class="text-yellow-400">Manual Airdrop</span>
        </div>
        <% } else { %>
        <!-- Interval-based scheduling -->
        <div class="text-xs text-gray-500">
          <span class="font-medium text-gray-400">Interval Schedule:</span>
          Snapshot interval <span class="text-cyan-400"><%= schedule.snapshotIntervalMinutes %> min</span> â†’
          Calculate after <span class="text-emerald-400"><%= schedule.calculateDelayMinutes %> min</span> â†’
          <span class="text-yellow-400">Manual Airdrop</span>
        </div>
        <% } %>

        <!-- Current status indicator -->
        <% if (scheduler && scheduler.nextAction && !['none', 'stopped', 'waiting-for-trigger', 'waiting-for-snapshot-cron'].includes(scheduler.nextAction)) { %>
        <div class="flex items-center gap-2">
          <div class="w-2 h-2 bg-cyan-400 rounded-full animate-pulse"></div>
          <span class="text-xs text-gray-400">
            Next: <span class="text-cyan-400 font-medium"><%= scheduler.nextAction %></span>
            <% if (scheduler.nextActionTime) { %>
            at <span class="text-white"><%= new Date(scheduler.nextActionTime).toLocaleTimeString() %></span>
            <% } %>
          </span>
        </div>
        <% } %>
      </div>

      <!-- Workflow Control Buttons -->
      <div class="flex items-center gap-3">
        <% if (scheduler && scheduler.nextAction === 'waiting-for-trigger') { %>
        <!-- Manual start button (interval mode) -->
        <div class="flex items-center gap-2 text-yellow-400 text-xs">
          <div class="w-2 h-2 bg-yellow-400 rounded-full"></div>
          <span>Waiting for manual start</span>
        </div>
        <button onclick="startWorkflow()" id="btnStartWorkflow"
          class="px-4 py-2 bg-gradient-to-r from-emerald-500 to-cyan-500 hover:from-emerald-400 hover:to-cyan-400 text-white text-sm font-medium rounded-lg transition-all disabled:opacity-50">
          ğŸš€ Start Workflow
        </button>
        <% } else if (scheduler && scheduler.nextAction === 'waiting-for-snapshot-cron') { %>
        <!-- Waiting for cron -->
        <div class="flex items-center gap-2 text-purple-400 text-xs">
          <div class="w-2 h-2 bg-purple-400 rounded-full animate-pulse"></div>
          <span>ğŸ“… Snapshot cron: <span class="font-mono"><%= schedule.snapshotCron %></span></span>
          <% if (scheduler.nextActionTime) { %>
          <span class="text-gray-400">â†’ next at <span class="text-white"><%= new Date(scheduler.nextActionTime).toLocaleTimeString() %></span></span>
          <% } %>
        </div>
        <% } else if (scheduler && scheduler.nextAction === 'waiting-for-calculate-cron') { %>
        <!-- Waiting for calculate cron -->
        <div class="flex items-center gap-2 text-emerald-400 text-xs">
          <div class="w-2 h-2 bg-emerald-400 rounded-full animate-pulse"></div>
          <span>ğŸ“… Calculate cron: <span class="font-mono"><%= schedule.calculateCron %></span></span>
          <% if (scheduler.nextActionTime) { %>
          <span class="text-gray-400">â†’ next at <span class="text-white"><%= new Date(scheduler.nextActionTime).toLocaleTimeString() %></span></span>
          <% } %>
        </div>
        <% } else if (scheduler && scheduler.nextAction === 'starting-soon' && scheduler.nextActionTime) { %>
        <!-- Countdown to start -->
        <div class="flex items-center gap-2 text-cyan-400 text-xs">
          <div class="w-2 h-2 bg-cyan-400 rounded-full animate-pulse"></div>
          <span>Starting in <span id="startCountdown" class="font-mono font-medium"></span></span>
        </div>
        <script>
          (function() {
            const targetTime = new Date('<%= scheduler.nextActionTime.toISOString() %>').getTime();
            function updateCountdown() {
              const now = Date.now();
              const diff = Math.max(0, targetTime - now);
              const minutes = Math.floor(diff / 60000);
              const seconds = Math.floor((diff % 60000) / 1000);
              document.getElementById('startCountdown').textContent = `${minutes}m ${seconds}s`;
              if (diff > 0) setTimeout(updateCountdown, 1000);
              else location.reload();
            }
            updateCountdown();
          })();
        </script>
        <% } else if (scheduler && scheduler.currentCycle > 0) { %>
        <!-- Cycle running -->
        <div class="text-xs text-gray-400">
          <span class="text-emerald-400 font-medium">Cycle #<%= scheduler.currentCycle %></span> running
        </div>
        <% } %>
      </div>
    </div>
  </div>
  <% } else if (!schedule || !schedule.useFastCycles) { %>
  <!-- Production Mode Weekly Schedule -->
  <div class="mt-4 pt-4 border-t border-dark-600">
    <div class="flex flex-wrap gap-6 items-center">
      <div class="text-xs text-gray-500">
        <span class="font-medium text-gray-400">Weekly Schedule (UTC):</span>
        Sunday 23:59 <span class="text-cyan-400">Snapshot</span> â†’
        Monday 00:30 <span class="text-emerald-400">Calculate</span> â†’
        <span class="text-yellow-400">Manual Airdrop</span>
      </div>
      <% if (scheduler && scheduler.nextAction && scheduler.nextAction !== 'none' && scheduler.nextAction !== 'stopped') { %>
      <div class="flex items-center gap-2">
        <div class="w-2 h-2 bg-cyan-400 rounded-full animate-pulse"></div>
        <span class="text-xs text-gray-400">
          Next: <span class="text-cyan-400 font-medium"><%= scheduler.nextAction %></span>
          <% if (scheduler.nextActionTime) { %>
          at <span class="text-white"><%= new Date(scheduler.nextActionTime).toISOString() %></span>
          <% } %>
        </span>
      </div>
      <% } %>
    </div>
  </div>
  <% } %>
</div>

<!-- Wallet Status -->
<% if (wallet && wallet.address) { %>
<div class="bg-dark-700 border <%= wallet.needsFunding ? 'border-yellow-500/50' : 'border-dark-500' %> rounded-xl p-5 mb-8">
  <div class="flex flex-wrap gap-6 items-center justify-between">
    <div class="flex items-center gap-6">
      <!-- Wallet Label -->
      <div>
        <span class="text-gray-500 text-xs uppercase block mb-1">Airdrop Wallet</span>
        <a href="https://basescan.org/address/<%= wallet.address %>" target="_blank"
           class="text-sm font-mono text-cyan-400 hover:text-cyan-300">
          <%= wallet.address.slice(0, 6) %>...<%= wallet.address.slice(-4) %>
        </a>
      </div>
      <!-- ETH Balance -->
      <div>
        <span class="text-gray-500 text-xs uppercase block mb-1">ETH (Gas)</span>
        <span class="text-lg font-mono <%= wallet.needsEth ? 'text-red-400' : 'text-white' %>">
          <%= wallet.ethBalance %> ETH
        </span>
        <% if (wallet.needsEth) { %>
        <span class="text-xs text-red-400 block">âš ï¸ Low</span>
        <% } %>
      </div>
      <!-- Token Balance -->
      <div>
        <span class="text-gray-500 text-xs uppercase block mb-1"><%= wallet.tokenSymbol %> (Airdrop)</span>
        <span class="text-lg font-mono <%= wallet.needsTokens ? 'text-red-400' : 'text-emerald-400' %>">
          <%= wallet.tokenBalance %> <%= wallet.tokenSymbol %>
        </span>
        <% if (wallet.needsTokens) { %>
        <span class="text-xs text-red-400 block">âš ï¸ Low</span>
        <% } %>
      </div>
    </div>

    <% if (wallet.needsFunding) { %>
    <!-- Funding Warning -->
    <div class="bg-yellow-500/10 border border-yellow-500/30 rounded-lg p-3 max-w-md">
      <div class="flex items-start gap-2">
        <span class="text-yellow-400 text-lg">âš ï¸</span>
        <div>
          <p class="text-yellow-400 text-sm font-medium">Wallet Needs Funding</p>
          <p class="text-yellow-200/70 text-xs mt-1">
            <% if (wallet.needsEth) { %>
            Send ETH for gas fees (min 0.01 ETH recommended).<br>
            <% } %>
            <% if (wallet.needsTokens) { %>
            Send <%= wallet.tokenSymbol %> tokens to enable airdrops.
            <% } %>
          </p>
          <button onclick="copyAddress('<%= wallet.address %>')"
                  class="mt-2 text-xs text-cyan-400 hover:text-cyan-300 underline">
            Copy Address
          </button>
        </div>
      </div>
    </div>
    <% } %>
  </div>
</div>

<script>
function copyAddress(address) {
  navigator.clipboard.writeText(address).then(() => {
    alert('Wallet address copied to clipboard!');
  });
}
</script>
<% } %>

<!-- Stats Cards -->
<div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 mb-8">
  <div class="bg-dark-700 border border-dark-500 rounded-xl p-5">
    <p class="text-gray-500 text-xs font-medium uppercase tracking-wide">Total Snapshots</p>
    <p class="text-2xl font-semibold text-white mt-1"><%= totalSnapshots %></p>
  </div>

  <div class="bg-dark-700 border border-dark-500 rounded-xl p-5">
    <p class="text-gray-500 text-xs font-medium uppercase tracking-wide">Total Distributions</p>
    <p class="text-2xl font-semibold text-white mt-1"><%= totalDistributions %></p>
  </div>

  <div class="bg-dark-700 border border-dark-500 rounded-xl p-5">
    <p class="text-gray-500 text-xs font-medium uppercase tracking-wide">Pending Batches</p>
    <p class="text-2xl font-semibold text-white mt-1"><%= pendingBatches %></p>
  </div>

  <div class="bg-dark-700 border border-dark-500 rounded-xl p-5">
    <p class="text-gray-500 text-xs font-medium uppercase tracking-wide">Latest Distribution</p>
    <p class="text-lg font-semibold text-white mt-1 font-mono"><%= latestDistribution?.weekId || 'â€”' %></p>
    <% if (latestDistribution) { %>
    <span class="inline-block mt-2 px-2 py-0.5 text-xs rounded-full
      <%= latestDistribution.status === 'completed' ? 'bg-emerald-500/20 text-emerald-400' :
         latestDistribution.status === 'failed' ? 'bg-red-500/20 text-red-400' :
         latestDistribution.status === 'ready' ? 'bg-cyan-500/20 text-cyan-400' :
         'bg-yellow-500/20 text-yellow-400' %>">
      <%= latestDistribution.status %>
    </span>
    <% } %>
  </div>
</div>

<!-- Test Triggers -->
<div class="bg-dark-700 border border-dark-500 rounded-xl mb-8">
  <div class="px-5 py-4 border-b border-dark-500 flex justify-between items-center">
    <div>
      <h2 class="text-base font-medium text-white">Manual Test Triggers</h2>
      <p class="text-gray-500 text-xs mt-0.5">Execute airdrop flow steps for testing</p>
    </div>
    <div class="text-right">
      <p class="text-gray-500 text-xs">Current Week</p>
      <p id="currentWeek" class="font-mono text-sm text-cyan-400"></p>
    </div>
  </div>
  <div class="p-5">
    <div class="flex flex-wrap gap-3 items-center">
      <button onclick="triggerSnapshot('start')" id="btnStartSnapshot"
        class="px-4 py-2 bg-dark-600 hover:bg-dark-500 text-gray-200 text-sm rounded-lg border border-dark-500 transition-colors disabled:opacity-50">
        1. Start Snapshot
      </button>
      <span class="text-dark-500">â†’</span>
      <button onclick="triggerSnapshot('end')" id="btnEndSnapshot"
        class="px-4 py-2 bg-dark-600 hover:bg-dark-500 text-gray-200 text-sm rounded-lg border border-dark-500 transition-colors disabled:opacity-50">
        2. End Snapshot
      </button>
      <span class="text-dark-500">â†’</span>
      <button onclick="triggerCalculation()" id="btnCalculate"
        class="px-4 py-2 bg-dark-600 hover:bg-dark-500 text-gray-200 text-sm rounded-lg border border-dark-500 transition-colors disabled:opacity-50">
        3. Calculate
      </button>
      <div class="border-l border-dark-500 pl-3 ml-1">
        <button onclick="triggerFullFlow()" id="btnFullFlow"
          class="px-4 py-2 bg-gradient-to-r from-cyan-500 to-emerald-500 hover:from-cyan-400 hover:to-emerald-400 text-white text-sm font-medium rounded-lg transition-all disabled:opacity-50">
          Run Full Flow
        </button>
      </div>
    </div>

    <!-- Dev Tools (visible in fork mode or development) -->
    <% if (isForkMode) { %>
    <div class="mt-4 pt-4 border-t border-dark-600">
      <div class="flex flex-wrap gap-3 items-center">
        <span class="text-gray-500 text-xs uppercase">Dev Tools:</span>
        <button onclick="clearCurrentWeek()" id="btnClearWeek"
          class="px-3 py-1.5 bg-dark-600 hover:bg-red-500/20 text-gray-400 hover:text-red-400 text-xs rounded border border-dark-500 hover:border-red-500/50 transition-colors disabled:opacity-50">
          Clear Current Week
        </button>
        <button onclick="clearAllData()" id="btnClearAll"
          class="px-3 py-1.5 bg-dark-600 hover:bg-red-500/20 text-gray-400 hover:text-red-400 text-xs rounded border border-dark-500 hover:border-red-500/50 transition-colors disabled:opacity-50">
          Clear All Data
        </button>
        <button onclick="deleteDatabase()" id="btnDeleteDb"
          class="px-3 py-1.5 bg-red-600 hover:bg-red-500 text-white text-xs rounded border border-red-500 transition-colors disabled:opacity-50">
          ğŸ—‘ï¸ Delete Database
        </button>
      </div>
    </div>
    <% } %>
  </div>
</div>

<!-- Pending Airdrops (Ready for Approval) -->
<% if (readyDistributions && readyDistributions.length > 0) { %>
<div class="bg-dark-700 border border-emerald-500/30 rounded-xl mb-8">
  <div class="px-5 py-4 border-b border-dark-500 flex justify-between items-center">
    <div class="flex items-center gap-3">
      <div class="w-2 h-2 bg-emerald-400 rounded-full animate-pulse"></div>
      <div>
        <h2 class="text-base font-medium text-white">Ready for Airdrop</h2>
        <p class="text-gray-500 text-xs mt-0.5"><%= readyDistributions.length %> distribution(s) awaiting approval</p>
      </div>
    </div>
  </div>
  <div class="p-5 space-y-3">
    <% readyDistributions.forEach(d => {
      const hasRewardConfig = d.config?.rewardPool && /^\d+$/.test(d.config.rewardPool) && BigInt(d.config.rewardPool) > 0n;
      const distRewardPool = hasRewardConfig ? (BigInt(d.config.rewardPool) / BigInt(10**18)).toString() : '';
      const distRewardToken = d.config?.rewardToken || rewardToken;
    %>
    <div class="flex items-center justify-between bg-dark-800 rounded-lg p-4">
      <div class="flex items-center gap-6">
        <div>
          <span class="font-mono text-white"><%= d.weekId %></span>
          <div class="text-xs text-gray-500 mt-1">
            <%= d.stats?.eligibleHolders || 0 %> eligible holders
          </div>
        </div>
        <div class="border-l border-dark-600 pl-6">
          <span class="text-xs text-gray-500 block">Reward Pool</span>
          <% if (hasRewardConfig) { %>
          <span class="text-sm font-mono text-emerald-400"><%= distRewardPool %> <%= distRewardToken %></span>
          <% } else { %>
          <span class="text-sm text-yellow-400">TBD (set on approval)</span>
          <% } %>
        </div>
      </div>
      <div class="flex items-center gap-3">
        <a href="/admin/distributions/<%= d._id %>" class="px-3 py-1.5 text-xs text-gray-400 hover:text-white transition-colors">
          View Details â†’
        </a>
        <button onclick="showApprovalModal('<%= d._id %>', '<%= d.weekId %>', <%= d.stats?.eligibleHolders || 0 %>, '<%= distRewardPool %>', '<%= distRewardToken %>')"
          class="px-4 py-2 bg-gradient-to-r from-emerald-500 to-cyan-500 hover:from-emerald-400 hover:to-cyan-400 text-white text-sm font-medium rounded-lg transition-all disabled:opacity-50">
          <% if (mockTransactions) { %>
          Simulate Airdrop
          <% } else { %>
          Execute Airdrop
          <% } %>
        </button>
      </div>
    </div>
    <% }) %>
  </div>
</div>
<% } %>

<!-- Approval Modal -->
<div id="approvalModal" class="fixed inset-0 bg-black/70 backdrop-blur-sm z-50 hidden flex items-center justify-center p-4">
  <div class="bg-dark-700 border border-dark-500 rounded-2xl w-full max-w-md shadow-2xl">
    <!-- Modal Header -->
    <div class="px-6 py-4 border-b border-dark-500">
      <div class="flex items-center justify-between">
        <h3 class="text-lg font-semibold text-white">Approve Airdrop</h3>
        <button onclick="closeApprovalModal()" class="text-gray-500 hover:text-white transition-colors">
          <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
          </svg>
        </button>
      </div>
    </div>

    <!-- Modal Body -->
    <div class="px-6 py-5">
      <!-- Week Info -->
      <div class="bg-dark-800 rounded-lg p-4 mb-5">
        <div class="flex justify-between items-center mb-2">
          <span class="text-gray-500 text-sm">Week</span>
          <span id="modalWeekId" class="font-mono text-cyan-400">â€”</span>
        </div>
        <div class="flex justify-between items-center">
          <span class="text-gray-500 text-sm">Eligible Holders</span>
          <span id="modalHolders" class="text-white font-medium">â€”</span>
        </div>
      </div>

      <!-- Reward Input -->
      <div class="mb-5">
        <label class="block text-sm font-medium text-gray-300 mb-2">
          Reward Pool Amount <span class="text-red-400">*</span>
        </label>
        <div class="flex">
          <input type="number" id="rewardAmount" step="0.001" min="0.001" placeholder="Enter amount to distribute"
            class="flex-1 bg-dark-800 border border-dark-500 text-white text-lg font-mono rounded-l-lg px-4 py-3 focus:border-cyan-500 focus:outline-none"
            required>
          <select id="rewardToken"
            class="bg-dark-600 border border-dark-500 border-l-0 text-white text-sm font-medium rounded-r-lg px-4 py-3 focus:outline-none">
            <option value="ETH" <%= rewardToken === 'ETH' ? 'selected' : '' %>>ETH</option>
            <option value="USDC" <%= rewardToken === 'USDC' ? 'selected' : '' %>>USDC</option>
            <option value="AQUARI" <%= rewardToken === 'AQUARI' ? 'selected' : '' %>>AQUARI</option>
          </select>
        </div>
        <p class="text-xs text-gray-500 mt-2">Enter the total amount to distribute proportionally to all eligible holders</p>
      </div>

      <!-- Mode Indicator -->
      <div class="bg-dark-800 rounded-lg p-4 mb-5">
        <div class="flex items-center gap-3">
          <% if (mockTransactions) { %>
          <div class="w-3 h-3 bg-purple-400 rounded-full"></div>
          <div>
            <span class="text-purple-400 font-medium text-sm">Simulation Mode</span>
            <p class="text-gray-500 text-xs">No real transactions will be sent</p>
          </div>
          <% } else { %>
          <div class="w-3 h-3 bg-red-400 rounded-full animate-pulse"></div>
          <div>
            <span class="text-red-400 font-medium text-sm">Production Mode</span>
            <p class="text-gray-500 text-xs">Real funds will be transferred!</p>
          </div>
          <% } %>
        </div>
      </div>

      <!-- Summary will be shown here -->
      <div id="rewardSummary" class="bg-emerald-500/10 border border-emerald-500/30 rounded-lg p-4 hidden">
        <div class="flex justify-between items-center">
          <span class="text-gray-400 text-sm">Estimated per holder</span>
          <span id="perHolderAmount" class="text-emerald-400 font-mono">â€”</span>
        </div>
      </div>
    </div>

    <!-- Modal Footer -->
    <div class="px-6 py-4 border-t border-dark-500 flex gap-3">
      <button onclick="closeApprovalModal()"
        class="flex-1 px-4 py-2.5 bg-dark-600 hover:bg-dark-500 text-gray-300 text-sm font-medium rounded-lg transition-colors">
        Cancel
      </button>
      <button onclick="confirmApproval()" id="btnConfirmApproval"
        class="flex-1 px-4 py-2.5 bg-gradient-to-r from-emerald-500 to-cyan-500 hover:from-emerald-400 hover:to-cyan-400 text-white text-sm font-medium rounded-lg transition-all disabled:opacity-50">
        <% if (mockTransactions) { %>
        Start Simulation
        <% } else { %>
        Execute Airdrop
        <% } %>
      </button>
    </div>
  </div>
</div>

<!-- Job Terminal / Live Logs -->
<div id="jobTerminal" class="bg-dark-700 border border-dark-500 rounded-xl mb-8 hidden">
  <div class="px-5 py-4 border-b border-dark-500 flex justify-between items-center">
    <div class="flex items-center gap-3">
      <div id="jobStatusIndicator" class="w-2 h-2 bg-cyan-400 rounded-full animate-pulse"></div>
      <div>
        <h2 class="text-base font-medium text-white">Job Progress</h2>
        <p id="jobTitle" class="text-gray-500 text-xs mt-0.5">Running job...</p>
      </div>
    </div>
    <div class="flex items-center gap-4">
      <div class="text-right">
        <p class="text-gray-500 text-xs">Progress</p>
        <p id="jobProgress" class="font-mono text-sm text-cyan-400">0%</p>
      </div>
      <button onclick="minimizeTerminal()" class="text-gray-500 hover:text-white transition-colors">
        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
        </svg>
      </button>
    </div>
  </div>

  <!-- Progress Bar -->
  <div class="px-5 py-3 bg-dark-800/50">
    <div class="flex justify-between text-xs text-gray-500 mb-2">
      <span id="jobStage">Initializing...</span>
      <span id="jobElapsed">0s</span>
    </div>
    <div class="w-full bg-dark-600 rounded-full h-2">
      <div id="jobProgressBar" class="bg-gradient-to-r from-cyan-500 to-emerald-500 h-2 rounded-full transition-all duration-300" style="width: 0%"></div>
    </div>
  </div>

  <!-- Terminal Output -->
  <div id="terminalOutput" class="bg-dark-900 font-mono text-xs overflow-auto max-h-80 p-4 space-y-1">
    <div class="text-gray-500">Waiting for job logs...</div>
  </div>

  <!-- Terminal Footer -->
  <div class="px-5 py-3 bg-dark-800/30 border-t border-dark-600 flex justify-between items-center">
    <div class="flex items-center gap-2 text-xs text-gray-500">
      <span>Job ID:</span>
      <span id="currentJobId" class="font-mono text-gray-400">â€”</span>
    </div>
    <div class="flex items-center gap-2">
      <button onclick="clearTerminal()" class="text-xs text-gray-500 hover:text-gray-300 transition-colors">Clear</button>
      <span class="text-dark-500">|</span>
      <button onclick="closeTerminal()" class="text-xs text-gray-500 hover:text-red-400 transition-colors">Close</button>
    </div>
  </div>
</div>

<!-- Recent Jobs -->
<div id="recentJobsSection" class="bg-dark-700 border border-dark-500 rounded-xl mb-8">
  <div class="px-5 py-4 border-b border-dark-500 flex justify-between items-center">
    <h2 class="text-base font-medium text-white">Recent Jobs</h2>
    <button onclick="refreshJobs()" class="text-xs text-cyan-400 hover:text-cyan-300 transition-colors">Refresh</button>
  </div>
  <div id="recentJobsList" class="divide-y divide-dark-600">
    <div class="px-5 py-8 text-center text-gray-500 text-sm">Loading jobs...</div>
  </div>
</div>

<!-- Recent Distributions -->
<div class="bg-dark-700 border border-dark-500 rounded-xl overflow-hidden">
  <div class="px-5 py-4 border-b border-dark-500">
    <h2 class="text-base font-medium text-white">Recent Distributions</h2>
  </div>
  <div class="overflow-x-auto">
    <table class="w-full">
      <thead>
        <tr class="bg-dark-800/50">
          <th class="px-5 py-3 text-left text-xs font-medium text-gray-500 uppercase">Week</th>
          <th class="px-5 py-3 text-left text-xs font-medium text-gray-500 uppercase">Status</th>
          <th class="px-5 py-3 text-left text-xs font-medium text-gray-500 uppercase">Eligible</th>
          <th class="px-5 py-3 text-left text-xs font-medium text-gray-500 uppercase">Created</th>
          <th class="px-5 py-3 text-left text-xs font-medium text-gray-500 uppercase">Actions</th>
        </tr>
      </thead>
      <tbody class="divide-y divide-dark-600">
        <% recentDistributions.forEach(d => { %>
        <tr class="hover:bg-dark-600/30 transition-colors">
          <td class="px-5 py-3 font-mono text-sm text-white"><%= d.weekId %></td>
          <td class="px-5 py-3">
            <span class="px-2 py-0.5 text-xs rounded-full
              <%= d.status === 'completed' ? 'bg-emerald-500/20 text-emerald-400' :
                 d.status === 'failed' ? 'bg-red-500/20 text-red-400' :
                 d.status === 'ready' ? 'bg-cyan-500/20 text-cyan-400' :
                 'bg-yellow-500/20 text-yellow-400' %>">
              <%= d.status %>
            </span>
          </td>
          <td class="px-5 py-3 text-sm text-gray-300"><%= d.stats?.eligibleHolders || 0 %></td>
          <td class="px-5 py-3 text-sm text-gray-500"><%= new Date(d.createdAt).toLocaleDateString() %></td>
          <td class="px-5 py-3">
            <a href="/admin/distributions/<%= d._id %>" class="text-sm text-cyan-400 hover:text-cyan-300">View â†’</a>
          </td>
        </tr>
        <% }) %>
        <% if (recentDistributions.length === 0) { %>
        <tr>
          <td colspan="5" class="px-5 py-8 text-center text-gray-500 text-sm">No distributions yet</td>
        </tr>
        <% } %>
      </tbody>
    </table>
  </div>
</div>

<script>
  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  // Utility Functions
  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

  function getCurrentWeekId() {
    const now = new Date();
    const start = new Date(now.getFullYear(), 0, 1);
    const days = Math.floor((now - start) / 86400000);
    const week = Math.ceil((days + start.getDay() + 1) / 7);
    return `${now.getFullYear()}-W${week.toString().padStart(2, '0')}`;
  }
  document.getElementById('currentWeek').textContent = getCurrentWeekId();

  function formatNumber(num) {
    return (num || 0).toLocaleString();
  }

  function formatDuration(ms) {
    const seconds = Math.floor(ms / 1000);
    const minutes = Math.floor(seconds / 60);
    const remainingSeconds = seconds % 60;
    if (minutes > 0) return `${minutes}m ${remainingSeconds}s`;
    return `${seconds}s`;
  }

  function formatTime(date) {
    return new Date(date).toLocaleTimeString('en-US', {
      hour12: false,
      hour: '2-digit',
      minute: '2-digit',
      second: '2-digit'
    });
  }

  function setLoading(id, loading) {
    const btn = document.getElementById(id);
    if (!btn) return;
    btn.disabled = loading;
    if (loading) { btn.dataset.text = btn.textContent; btn.textContent = 'Processing...'; }
    else if (btn.dataset.text) btn.textContent = btn.dataset.text;
  }

  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  // Terminal / Job Tracking
  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

  let currentJobId = null;
  let jobPollInterval = null;
  let jobStartTime = null;
  let lastLogCount = 0;
  let isViewingHistoricalJob = false; // Track if viewing completed/failed job

  function showTerminal(jobId, title, historical = false) {
    currentJobId = jobId;
    jobStartTime = Date.now();
    lastLogCount = 0;
    isViewingHistoricalJob = historical;

    document.getElementById('jobTerminal').classList.remove('hidden');
    document.getElementById('jobTitle').textContent = title;
    document.getElementById('currentJobId').textContent = jobId;
    document.getElementById('terminalOutput').innerHTML = '<div class="text-cyan-400">â— Loading logs...</div>';
    document.getElementById('jobProgress').textContent = '0%';
    document.getElementById('jobProgressBar').style.width = '0%';
    document.getElementById('jobStage').textContent = 'Loading...';
    document.getElementById('jobStatusIndicator').className = 'w-2 h-2 bg-cyan-400 rounded-full animate-pulse';

    // Start polling
    if (jobPollInterval) clearInterval(jobPollInterval);
    jobPollInterval = setInterval(pollJobStatus, 1000);
    pollJobStatus(); // Immediate first poll
  }

  function closeTerminal() {
    document.getElementById('jobTerminal').classList.add('hidden');
    if (jobPollInterval) {
      clearInterval(jobPollInterval);
      jobPollInterval = null;
    }
    currentJobId = null;
  }

  function minimizeTerminal() {
    const output = document.getElementById('terminalOutput');
    output.classList.toggle('hidden');
  }

  function clearTerminal() {
    document.getElementById('terminalOutput').innerHTML = '<div class="text-gray-500">Terminal cleared</div>';
    lastLogCount = 0;
  }

  function appendLog(log) {
    const output = document.getElementById('terminalOutput');
    const div = document.createElement('div');

    const time = formatTime(log.timestamp);
    let colorClass = 'text-gray-300';
    let icon = '  ';

    switch (log.level) {
      case 'info':
        colorClass = 'text-gray-300';
        icon = 'â—‹';
        break;
      case 'warn':
        colorClass = 'text-yellow-400';
        icon = 'âš ';
        break;
      case 'error':
        colorClass = 'text-red-400';
        icon = 'âœ—';
        break;
      case 'success':
        colorClass = 'text-emerald-400';
        icon = 'âœ“';
        break;
    }

    div.className = colorClass;
    div.innerHTML = `<span class="text-gray-600">[${time}]</span> ${icon} ${escapeHtml(log.message)}`;

    if (log.data && Object.keys(log.data).length > 0) {
      const dataSpan = document.createElement('span');
      dataSpan.className = 'text-gray-500 ml-2';
      dataSpan.textContent = JSON.stringify(log.data);
      div.appendChild(dataSpan);
    }

    output.appendChild(div);
    output.scrollTop = output.scrollHeight;
  }

  function escapeHtml(text) {
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
  }

  async function pollJobStatus() {
    if (!currentJobId) return;

    try {
      const res = await fetch(`/admin/jobs/${currentJobId}/logs`);
      const data = await res.json();

      if (!data.success) {
        console.error('Failed to fetch job logs:', data.error);
        return;
      }

      const job = data.job;
      const logs = data.logs || [];

      // Update elapsed time
      const elapsed = Date.now() - jobStartTime;
      document.getElementById('jobElapsed').textContent = formatDuration(elapsed);

      // Update progress
      if (job.progress) {
        const percent = job.progress.percentage || 0;
        document.getElementById('jobProgress').textContent = `${percent}%`;
        document.getElementById('jobProgressBar').style.width = `${percent}%`;
        document.getElementById('jobStage').textContent = job.progress.stage || 'Processing...';
      }

      // Append new logs
      if (logs.length > lastLogCount) {
        const newLogs = logs.slice(lastLogCount);
        newLogs.forEach(appendLog);
        lastLogCount = logs.length;
      }

      // Update status indicator
      const indicator = document.getElementById('jobStatusIndicator');
      if (job.status === 'completed') {
        indicator.className = 'w-2 h-2 bg-emerald-400 rounded-full';
        document.getElementById('jobProgress').textContent = '100%';
        document.getElementById('jobProgressBar').style.width = '100%';
        document.getElementById('jobStage').textContent = 'Completed';

        // Stop polling
        if (jobPollInterval) {
          clearInterval(jobPollInterval);
          jobPollInterval = null;
        }

        // Only reload if watching a live job (not viewing historical logs)
        if (!isViewingHistoricalJob) {
          setTimeout(() => {
            refreshJobs();
            location.reload();
          }, 3000);
        }
      } else if (job.status === 'failed') {
        indicator.className = 'w-2 h-2 bg-red-400 rounded-full';
        document.getElementById('jobProgressBar').classList.remove('from-cyan-500', 'to-emerald-500');
        document.getElementById('jobProgressBar').classList.add('bg-red-500');
        document.getElementById('jobStage').textContent = 'Failed';

        // Stop polling
        if (jobPollInterval) {
          clearInterval(jobPollInterval);
          jobPollInterval = null;
        }
      }

    } catch (e) {
      console.error('Poll error:', e);
    }
  }

  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  // Recent Jobs List
  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

  async function refreshJobs() {
    try {
      const res = await fetch('/admin/jobs/status');
      const data = await res.json();
      console.log('Jobs status:', data);

      if (!data.success) return;

      const container = document.getElementById('recentJobsList');
      // Use activeJobs and recentJobs from API response
      const activeJobs = data.activeJobs || data.active || [];
      const recentJobs = data.recentJobs || data.recent || [];
      const jobs = [...activeJobs, ...recentJobs];

      if (jobs.length === 0) {
        container.innerHTML = '<div class="px-5 py-8 text-center text-gray-500 text-sm">No jobs yet</div>';
        return;
      }

      container.innerHTML = jobs.slice(0, 10).map(job => {
        const jobId = job.id || job._id;
        const statusColors = {
          pending: 'bg-gray-500/20 text-gray-400',
          running: 'bg-cyan-500/20 text-cyan-400',
          completed: 'bg-emerald-500/20 text-emerald-400',
          failed: 'bg-red-500/20 text-red-400'
        };
        const statusColor = statusColors[job.status] || statusColors.pending;
        const progress = job.progress ? `${job.progress.percentage || 0}%` : 'â€”';
        const created = job.createdAt ? new Date(job.createdAt).toLocaleString() : 'â€”';

        return `
          <div class="px-5 py-3 flex items-center justify-between hover:bg-dark-600/30 transition-colors">
            <div class="flex items-center gap-4">
              <div class="w-10 h-10 rounded-lg bg-dark-600 flex items-center justify-center">
                ${getJobIcon(job.type)}
              </div>
              <div>
                <p class="text-sm text-white font-medium">${escapeHtml(job.type)} <span class="text-gray-500">â€¢</span> <span class="font-mono text-gray-400">${escapeHtml(job.weekId)}</span></p>
                <p class="text-xs text-gray-500">${created}</p>
              </div>
            </div>
            <div class="flex items-center gap-4">
              ${job.status === 'running' ? `<span class="text-xs text-cyan-400 font-mono">${progress}</span>` : ''}
              <span class="px-2 py-0.5 text-xs rounded-full ${statusColor}">${job.status}</span>
              ${job.status === 'running' || job.status === 'completed' || job.status === 'failed' ?
                `<button onclick="viewJobLogs('${jobId}')" class="text-xs text-cyan-400 hover:text-cyan-300">View Logs</button>` : ''}
            </div>
          </div>
        `;
      }).join('');

      // Check if any active jobs need terminal
      const activeJob = activeJobs.find(j => j.status === 'running');
      if (activeJob && !currentJobId) {
        const jobId = activeJob.id || activeJob._id;
        showTerminal(jobId, `${activeJob.type} - ${activeJob.weekId}`);
      }

    } catch (e) {
      console.error('Failed to refresh jobs:', e);
    }
  }

  function getJobIcon(type) {
    const icons = {
      snapshot: '<svg class="w-5 h-5 text-cyan-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 9a2 2 0 012-2h.93a2 2 0 001.664-.89l.812-1.22A2 2 0 0110.07 4h3.86a2 2 0 011.664.89l.812 1.22A2 2 0 0018.07 7H19a2 2 0 012 2v9a2 2 0 01-2 2H5a2 2 0 01-2-2V9z"></path><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 13a3 3 0 11-6 0 3 3 0 016 0z"></path></svg>',
      calculation: '<svg class="w-5 h-5 text-emerald-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 7h6m0 10v-3m-3 3h.01M9 17h.01M9 14h.01M12 14h.01M15 11h.01M12 11h.01M9 11h.01M7 21h10a2 2 0 002-2V5a2 2 0 00-2-2H7a2 2 0 00-2 2v14a2 2 0 002 2z"></path></svg>',
      airdrop: '<svg class="w-5 h-5 text-yellow-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>',
      'full-flow': '<svg class="w-5 h-5 text-purple-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"></path></svg>'
    };
    return icons[type] || icons.snapshot;
  }

  async function viewJobLogs(jobId) {
    // Mark as historical so it won't auto-reload
    showTerminal(jobId, 'Job Logs', true);
  }

  // Initialize on page load
  async function init() {
    await refreshJobs();

    // Check for any running jobs and show terminal
    try {
      const res = await fetch('/admin/jobs/status');
      const data = await res.json();
      const activeJobs = data.activeJobs || [];
      const runningJob = activeJobs.find(j => j.status === 'running');

      if (runningJob) {
        const jobId = runningJob.id || runningJob._id;
        console.log('Found running job:', jobId, runningJob);
        showTerminal(jobId, `${runningJob.type} - ${runningJob.weekId}`);
      }
    } catch (e) {
      console.error('Init error:', e);
    }
  }

  init();
  setInterval(refreshJobs, 5000); // Refresh every 5 seconds

  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  // Trigger Functions
  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

  async function triggerSnapshot(type) {
    const id = type === 'start' ? 'btnStartSnapshot' : 'btnEndSnapshot';
    const weekId = getCurrentWeekId();
    const snapshotWeekId = `${weekId}-${type}`;

    setLoading(id, true);

    try {
      const res = await fetch('/admin/trigger/snapshot', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ type })
      });
      const data = await res.json();
      console.log('Trigger response:', data);

      if (data.success && data.job) {
        const jobId = data.job.id || data.job._id;
        showTerminal(jobId, `Snapshot ${type} - ${snapshotWeekId}`);
      } else {
        alert(data.error || 'Failed to start job');
      }
    } catch (e) {
      alert('Error: ' + e.message);
    } finally {
      setLoading(id, false);
    }
  }

  async function triggerCalculation() {
    setLoading('btnCalculate', true);
    const weekId = getCurrentWeekId();

    try {
      const res = await fetch('/admin/trigger/calculate', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' }
      });
      const data = await res.json();
      console.log('Trigger response:', data);

      if (data.success && data.job) {
        const jobId = data.job.id || data.job._id;
        showTerminal(jobId, `Calculation - ${weekId}`);
      } else {
        alert(data.error || 'Failed to start job');
      }
    } catch (e) {
      alert('Error: ' + e.message);
    } finally {
      setLoading('btnCalculate', false);
    }
  }

  async function triggerFullFlow() {
    setLoading('btnFullFlow', true);
    const weekId = getCurrentWeekId();

    try {
      const res = await fetch('/admin/trigger/full-flow', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' }
      });
      const data = await res.json();
      console.log('Trigger response:', data);

      if (data.success && data.job) {
        const jobId = data.job.id || data.job._id;
        showTerminal(jobId, `Full Flow - ${weekId}`);
      } else {
        alert(data.error || 'Failed to start job');
      }
    } catch (e) {
      alert('Error: ' + e.message);
    } finally {
      setLoading('btnFullFlow', false);
    }
  }

  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  // Workflow Control
  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

  async function startWorkflow() {
    if (!confirm('Start the airdrop workflow now?')) return;
    setLoading('btnStartWorkflow', true);

    try {
      const res = await fetch('/admin/workflow/start', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' }
      });
      const data = await res.json();
      console.log('Start workflow response:', data);

      if (data.success) {
        alert('Workflow started successfully!');
        location.reload();
      } else {
        alert(data.error || 'Failed to start workflow');
      }
    } catch (e) {
      alert('Error: ' + e.message);
    } finally {
      setLoading('btnStartWorkflow', false);
    }
  }

  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  // Dev Tools
  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

  async function clearCurrentWeek() {
    if (!confirm('Clear all data for current week? This cannot be undone.')) return;
    setLoading('btnClearWeek', true);
    try {
      const weekId = getCurrentWeekId();
      const res = await fetch('/admin/dev/clear-data', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ weekId })
      });
      const data = await res.json();
      if (data.success) {
        alert('Data cleared successfully');
        location.reload();
      } else {
        alert(data.error || 'Failed to clear data');
      }
    } catch (e) {
      alert('Error: ' + e.message);
    } finally {
      setLoading('btnClearWeek', false);
    }
  }

  async function clearAllData() {
    if (!confirm('Clear ALL data from database? This cannot be undone.')) return;
    if (!confirm('Are you really sure? ALL snapshots, distributions, recipients, and batches will be deleted.')) return;
    setLoading('btnClearAll', true);
    try {
      const res = await fetch('/admin/dev/clear-data', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ collection: 'all' })
      });
      const data = await res.json();
      if (data.success) {
        alert('All data cleared successfully');
        location.reload();
      } else {
        alert(data.error || 'Failed to clear data');
      }
    } catch (e) {
      alert('Error: ' + e.message);
    } finally {
      setLoading('btnClearAll', false);
    }
  }

  async function deleteDatabase() {
    if (!confirm('âš ï¸ DELETE ENTIRE DATABASE?\n\nThis will drop ALL collections including:\n- snapshots\n- holders\n- distributions\n- recipients\n- batches\n- jobs\n\nThis action CANNOT be undone!')) return;
    if (!confirm('âš ï¸ FINAL WARNING âš ï¸\n\nType "DELETE" in the next prompt to confirm database deletion.')) return;

    const confirmation = prompt('Type DELETE to confirm database deletion:');
    if (confirmation !== 'DELETE') {
      alert('Database deletion cancelled.');
      return;
    }

    setLoading('btnDeleteDb', true);
    try {
      const res = await fetch('/admin/dev/delete-database', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' }
      });
      const data = await res.json();
      if (data.success) {
        alert('Database deleted successfully. All collections have been dropped.');
        location.reload();
      } else {
        alert(data.error || 'Failed to delete database');
      }
    } catch (e) {
      alert('Error: ' + e.message);
    } finally {
      setLoading('btnDeleteDb', false);
    }
  }

  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  // Airdrop Approval Modal
  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

  let currentApprovalData = null;

  function showApprovalModal(distributionId, weekId, eligibleHolders, configuredRewardPool, configuredRewardToken) {
    currentApprovalData = { distributionId, weekId, eligibleHolders };

    // Update modal content
    document.getElementById('modalWeekId').textContent = weekId;
    document.getElementById('modalHolders').textContent = eligibleHolders.toLocaleString();

    // Set input to distribution's configured value (or empty for admin to enter)
    document.getElementById('rewardAmount').value = configuredRewardPool || '';
    document.getElementById('rewardToken').value = configuredRewardToken || '<%= rewardToken %>';

    // Update per-holder estimate (will hide if no amount)
    updatePerHolderEstimate();

    // Show modal
    document.getElementById('approvalModal').classList.remove('hidden');

    // Focus on input for quick entry
    document.getElementById('rewardAmount').focus();
  }

  // Register event listeners once (outside the function to prevent stacking)
  document.getElementById('rewardAmount')?.addEventListener('input', updatePerHolderEstimate);
  document.getElementById('rewardToken')?.addEventListener('change', updatePerHolderEstimate);

  function closeApprovalModal() {
    document.getElementById('approvalModal').classList.add('hidden');
    currentApprovalData = null;
  }

  function updatePerHolderEstimate() {
    if (!currentApprovalData) return;

    const amount = parseFloat(document.getElementById('rewardAmount').value) || 0;
    const token = document.getElementById('rewardToken').value;
    const holders = currentApprovalData.eligibleHolders;

    if (amount > 0 && holders > 0) {
      const perHolder = amount / holders;
      document.getElementById('perHolderAmount').textContent = `~${perHolder.toFixed(8)} ${token}`;
      document.getElementById('rewardSummary').classList.remove('hidden');
    } else {
      document.getElementById('rewardSummary').classList.add('hidden');
    }
  }

  async function confirmApproval() {
    if (!currentApprovalData) return;

    const { distributionId, weekId } = currentApprovalData;
    const rewardAmount = parseFloat(document.getElementById('rewardAmount').value);
    const rewardToken = document.getElementById('rewardToken').value;
    const mode = '<%= mockTransactions ? "SIMULATED" : "PRODUCTION" %>';

    if (!rewardAmount || rewardAmount <= 0) {
      alert('Please enter a valid reward amount');
      return;
    }

    // Production mode double confirmation
    if (mode !== 'SIMULATED') {
      if (!confirm(`âš ï¸ PRODUCTION MODE âš ï¸\n\nYou are about to distribute ${rewardAmount} ${rewardToken} to ${currentApprovalData.eligibleHolders} holders.\n\nThis action CANNOT be undone. Continue?`)) {
        return;
      }
    }

    const btn = document.getElementById('btnConfirmApproval');
    btn.disabled = true;
    btn.textContent = 'Starting...';

    try {
      // Convert to wei (18 decimals)
      const rewardPoolWei = (BigInt(Math.floor(rewardAmount * 1e6)) * BigInt(1e12)).toString();

      const res = await fetch('/admin/approve-airdrop', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          distributionId,
          rewardPool: rewardPoolWei,
          rewardToken
        })
      });
      const data = await res.json();
      console.log('Approve response:', data);

      if (data.success && data.job) {
        closeApprovalModal();
        const jobId = data.job.id || data.job._id;
        showTerminal(jobId, `Airdrop ${mode} - ${weekId}`);
      } else {
        alert(data.error || 'Failed to start airdrop');
        btn.disabled = false;
        btn.textContent = mode === 'SIMULATED' ? 'Start Simulation' : 'Execute Airdrop';
      }
    } catch (e) {
      alert('Error: ' + e.message);
      btn.disabled = false;
      btn.textContent = mode === 'SIMULATED' ? 'Start Simulation' : 'Execute Airdrop';
    }
  }

  // Close modal on escape key
  document.addEventListener('keydown', (e) => {
    if (e.key === 'Escape') closeApprovalModal();
  });

  // Close modal on backdrop click
  document.getElementById('approvalModal')?.addEventListener('click', (e) => {
    if (e.target.id === 'approvalModal') closeApprovalModal();
  });
</script>
