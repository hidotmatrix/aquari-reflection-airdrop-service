<div class="mb-6">
  <a href="/admin/snapshots" class="text-cyan-400 hover:text-cyan-300 text-sm">&larr; Back to Snapshots</a>
</div>

<div class="bg-dark-700 border border-dark-500 rounded-xl p-5 mb-6">
  <h1 class="text-xl font-semibold text-white mb-4">Snapshot: <span class="font-mono text-cyan-400"><%= snapshot.weekId %></span></h1>
  <div class="grid grid-cols-2 md:grid-cols-4 gap-4 text-sm">
    <div>
      <span class="text-gray-500">Status</span>
      <p class="mt-1">
        <span id="snapshotStatus" class="px-2 py-0.5 text-xs rounded-full
          <%= snapshot.status === 'completed' ? 'bg-emerald-500/20 text-emerald-400' :
             snapshot.status === 'failed' ? 'bg-red-500/20 text-red-400' :
             snapshot.status === 'in_progress' ? 'bg-cyan-500/20 text-cyan-400' :
             'bg-yellow-500/20 text-yellow-400' %>">
          <%= snapshot.status %>
        </span>
      </p>
    </div>
    <div>
      <span class="text-gray-500">Total Holders</span>
      <p id="totalHolders" class="text-white font-medium mt-1"><%= snapshot.totalHolders?.toLocaleString() || (snapshot.progress?.insertedCount?.toLocaleString() || 0) %></p>
    </div>
    <div>
      <span class="text-gray-500">Timestamp</span>
      <p class="text-gray-300 mt-1"><%= new Date(snapshot.timestamp).toLocaleString() %></p>
    </div>
    <div>
      <span class="text-gray-500">API Calls</span>
      <p class="text-gray-300 mt-1"><%= snapshot.metadata?.apiCallCount || 0 %></p>
    </div>
  </div>

  <% if (snapshot.error) { %>
  <div class="mt-4 p-3 rounded-lg bg-red-500/10 border border-red-500/20">
    <p class="text-red-400 text-sm"><strong>Error:</strong> <%= snapshot.error %></p>
  </div>
  <% } %>
</div>

<% if (snapshot.status === 'in_progress') { %>
<!-- Progress Panel for In-Progress Snapshots -->
<div id="progressPanel" class="bg-dark-700 border border-dark-500 rounded-xl p-5 mb-6">
  <div class="flex items-center justify-between mb-4">
    <div class="flex items-center gap-2">
      <div class="w-2 h-2 bg-cyan-400 rounded-full animate-pulse"></div>
      <h2 class="text-base font-medium text-white">Snapshot In Progress</h2>
    </div>
    <span id="progressTime" class="text-xs text-gray-500"></span>
  </div>

  <div class="space-y-3">
    <div class="flex justify-between text-sm">
      <span class="text-gray-400">Holders fetched:</span>
      <span id="progressFetched" class="font-mono text-cyan-400"><%= snapshot.progress?.fetchedCount?.toLocaleString() || 0 %></span>
    </div>
    <div class="flex justify-between text-sm">
      <span class="text-gray-400">Holders saved:</span>
      <span id="progressInserted" class="font-mono text-emerald-400"><%= snapshot.progress?.insertedCount?.toLocaleString() || 0 %></span>
    </div>
    <% if (snapshot.progress?.lastCursor) { %>
    <div class="flex justify-between text-sm">
      <span class="text-gray-400">Cursor:</span>
      <span class="font-mono text-gray-500 text-xs truncate max-w-xs"><%= snapshot.progress.lastCursor.substring(0, 30) %>...</span>
    </div>
    <% } %>

    <div class="w-full bg-dark-600 rounded-full h-2 mt-3">
      <div id="progressBar" class="bg-gradient-to-r from-cyan-500 to-emerald-500 h-2 rounded-full transition-all duration-500" style="width: 10%"></div>
    </div>

    <p id="progressStatus" class="text-xs text-gray-500 mt-2">Fetching holders from Moralis API...</p>
  </div>
</div>
<% } %>

<div class="bg-dark-700 border border-dark-500 rounded-xl overflow-hidden">
  <div class="px-5 py-4 border-b border-dark-500 flex justify-between items-center">
    <h2 class="text-base font-medium text-white">Holders (Top by Balance)</h2>
    <span id="holderCount" class="text-sm text-gray-500"><%= pagination.total.toLocaleString() %> holders</span>
  </div>
  <table class="w-full">
    <thead>
      <tr class="bg-dark-800/50">
        <th class="px-5 py-3 text-left text-xs font-medium text-gray-500 uppercase">Address</th>
        <th class="px-5 py-3 text-left text-xs font-medium text-gray-500 uppercase">Balance</th>
        <th class="px-5 py-3 text-left text-xs font-medium text-gray-500 uppercase">Label</th>
      </tr>
    </thead>
    <tbody id="holdersTable" class="divide-y divide-dark-600">
      <% holders.forEach(h => { %>
      <tr class="hover:bg-dark-600/30 transition-colors">
        <td class="px-5 py-3 font-mono text-sm text-cyan-400"><%= h.address %></td>
        <td class="px-5 py-3 text-sm text-gray-300"><%= h.balanceFormatted %></td>
        <td class="px-5 py-3 text-sm text-gray-500"><%= h.label || h.entity || '—' %></td>
      </tr>
      <% }) %>
      <% if (holders.length === 0) { %>
      <tr id="noHoldersRow">
        <td colspan="3" class="px-5 py-8 text-center text-gray-500 text-sm">
          <% if (snapshot.status === 'in_progress') { %>
          Holders will appear here as they are saved...
          <% } else { %>
          No holders found
          <% } %>
        </td>
      </tr>
      <% } %>
    </tbody>
  </table>
</div>

<% if (pagination.totalPages > 1) { %>
<div class="mt-4 flex justify-center gap-2">
  <% for (let i = 1; i <= Math.min(pagination.totalPages, 10); i++) { %>
  <a href="?page=<%= i %>" class="px-3 py-1 text-sm rounded <%= i === pagination.page ? 'bg-cyan-500 text-white' : 'bg-dark-700 text-gray-400 hover:text-white' %>"><%= i %></a>
  <% } %>
  <% if (pagination.totalPages > 10) { %>
  <span class="px-3 py-1 text-sm text-gray-500">... <%= pagination.totalPages %></span>
  <% } %>
</div>
<% } %>

<% if (snapshot.status === 'in_progress') { %>
<script>
  const snapshotId = '<%= snapshot._id %>';
  const weekId = '<%= snapshot.weekId %>';
  let startTime = new Date('<%= snapshot.progress?.startedAt || snapshot.createdAt %>').getTime();
  let pollInterval = null;

  function formatDuration(ms) {
    const seconds = Math.floor(ms / 1000);
    const minutes = Math.floor(seconds / 60);
    const remainingSeconds = seconds % 60;
    if (minutes > 0) return `${minutes}m ${remainingSeconds}s`;
    return `${seconds}s`;
  }

  function formatNumber(num) {
    return num.toLocaleString();
  }

  async function pollProgress() {
    try {
      const res = await fetch(`/admin/status/snapshot?weekId=${encodeURIComponent(weekId)}`);
      const data = await res.json();

      if (!data.success) return;

      const progress = data.dbSnapshot?.progress;
      const status = data.dbSnapshot?.status;

      if (progress) {
        const fetched = progress.fetchedCount || 0;
        const inserted = progress.insertedCount || 0;

        document.getElementById('progressFetched').textContent = formatNumber(fetched);
        document.getElementById('progressInserted').textContent = formatNumber(inserted);
        document.getElementById('totalHolders').textContent = formatNumber(inserted);

        // Update progress bar (estimate)
        const estimatedTotal = Math.max(fetched * 1.1, 10000);
        const percent = Math.min((inserted / estimatedTotal) * 100, 95);
        document.getElementById('progressBar').style.width = `${percent}%`;

        // Update status text
        if (inserted > 0) {
          document.getElementById('progressStatus').textContent = `Saving holders to database... ${formatNumber(inserted)} saved`;
        }

        // Update elapsed time
        const elapsed = Date.now() - startTime;
        document.getElementById('progressTime').textContent = `Elapsed: ${formatDuration(elapsed)}`;
      }

      // Check if completed or failed
      if (status === 'completed') {
        document.getElementById('snapshotStatus').textContent = 'completed';
        document.getElementById('snapshotStatus').className = 'px-2 py-0.5 text-xs rounded-full bg-emerald-500/20 text-emerald-400';
        document.getElementById('progressBar').style.width = '100%';
        document.getElementById('progressStatus').textContent = '✓ Snapshot completed!';
        document.getElementById('totalHolders').textContent = formatNumber(data.dbSnapshot.totalHolders);

        clearInterval(pollInterval);
        setTimeout(() => location.reload(), 2000);
      } else if (status === 'failed') {
        document.getElementById('snapshotStatus').textContent = 'failed';
        document.getElementById('snapshotStatus').className = 'px-2 py-0.5 text-xs rounded-full bg-red-500/20 text-red-400';
        document.getElementById('progressStatus').textContent = `✗ Failed: ${data.dbSnapshot.error || 'Unknown error'}`;
        document.getElementById('progressBar').classList.remove('from-cyan-500', 'to-emerald-500');
        document.getElementById('progressBar').classList.add('bg-red-500');

        clearInterval(pollInterval);
      }
    } catch (e) {
      console.error('Progress poll error:', e);
    }
  }

  // Start polling
  pollInterval = setInterval(pollProgress, 2000);
  pollProgress(); // Initial poll

  // Update elapsed time every second
  setInterval(() => {
    const elapsed = Date.now() - startTime;
    const timeEl = document.getElementById('progressTime');
    if (timeEl) {
      timeEl.textContent = `Elapsed: ${formatDuration(elapsed)}`;
    }
  }, 1000);
</script>
<% } %>
