<!-- Dashboard Header -->
<div class="mb-8">
  <h1 class="text-2xl font-semibold text-white">Dashboard</h1>
  <p class="text-gray-500 text-sm mt-1">Monitor your weekly airdrop distributions</p>
</div>

<!-- Config & Mode Indicators -->
<div class="bg-dark-700 border border-dark-500 rounded-xl p-5 mb-8">
  <div class="flex flex-wrap gap-6 items-center justify-between">
    <div class="flex items-center gap-6">
      <!-- Network -->
      <div>
        <span class="text-gray-500 text-xs uppercase block mb-1">Network</span>
        <span class="text-lg font-mono <%= isForkMode ? 'text-yellow-400' : 'text-cyan-400' %>">
          <%= network.name %>
        </span>
        <span class="text-gray-500 text-xs block">(Chain ID: <%= network.chainId %>)</span>
      </div>
      <!-- Minimum Balance -->
      <div>
        <span class="text-gray-500 text-xs uppercase block mb-1">Min Balance</span>
        <span class="text-lg font-mono text-white"><%= minBalance %> AQUARI</span>
      </div>
      <!-- Reward Token -->
      <div>
        <span class="text-gray-500 text-xs uppercase block mb-1">Reward Token</span>
        <span class="text-lg font-mono text-white"><%= rewardToken %></span>
      </div>
    </div>
    <!-- Mode Indicators -->
    <div class="flex items-center gap-3">
      <% if (isForkMode) { %>
      <span class="px-3 py-1 text-xs font-medium rounded-full bg-yellow-500/20 text-yellow-400 border border-yellow-500/30">
        FORK MODE
      </span>
      <% } else { %>
      <span class="px-3 py-1 text-xs font-medium rounded-full bg-emerald-500/20 text-emerald-400 border border-emerald-500/30">
        PRODUCTION
      </span>
      <% } %>
      <% if (mockSnapshots) { %>
      <span class="px-3 py-1 text-xs font-medium rounded-full bg-gray-500/20 text-gray-400 border border-gray-500/30">
        MOCK DATA
      </span>
      <% } %>
      <% if (mockTransactions) { %>
      <span class="px-3 py-1 text-xs font-medium rounded-full bg-purple-500/20 text-purple-400 border border-purple-500/30">
        SIMULATED TX
      </span>
      <% } else { %>
      <span class="px-3 py-1 text-xs font-medium rounded-full bg-red-500/20 text-red-400 border border-red-500/30 animate-pulse">
        LIVE TX
      </span>
      <% } %>
    </div>
  </div>

  <!-- Cron Schedule Display -->
  <% if (schedule) { %>
  <div class="mt-4 pt-4 border-t border-dark-600">
    <div class="flex flex-wrap gap-6 items-center justify-between">
      <div class="text-xs text-gray-500">
        <span class="font-medium text-gray-400">4-Step Cron Schedule:</span>
        <% if (schedule.startSnapshotCron) { %>
        <span class="text-cyan-400 font-mono ml-2"><%= schedule.startSnapshotCron %></span> Start
        <% } %>
        <% if (schedule.endSnapshotCron) { %>
        â†’ <span class="text-cyan-400 font-mono"><%= schedule.endSnapshotCron %></span> End
        <% } %>
        <% if (schedule.calculateCron) { %>
        â†’ <span class="text-emerald-400 font-mono"><%= schedule.calculateCron %></span> Calculate
        <% } %>
        <% if (schedule.airdropCron) { %>
        â†’ <span class="text-yellow-400 font-mono"><%= schedule.airdropCron %></span> Airdrop
        <% } %>
      </div>

      <% if (scheduler && scheduler.nextAction && scheduler.nextAction !== 'none' && scheduler.nextAction !== 'stopped') { %>
      <div class="flex items-center gap-2">
        <div class="w-2 h-2 bg-cyan-400 rounded-full animate-pulse"></div>
        <span class="text-xs text-gray-400">
          Next: <span class="text-cyan-400 font-medium"><%= scheduler.nextAction.replace(/-/g, ' ') %></span>
          <% if (scheduler.nextActionTime) { %>
          at <span class="text-white"><%= new Date(scheduler.nextActionTime).toLocaleTimeString() %></span>
          <% } %>
        </span>
      </div>
      <% } %>
    </div>
  </div>
  <% } %>
</div>

<!-- Wallet Status -->
<% if (wallet && wallet.address) { %>
<div class="bg-dark-700 border <%= wallet.needsFunding ? 'border-yellow-500/50' : 'border-dark-500' %> rounded-xl p-5 mb-8">
  <div class="flex flex-wrap gap-6 items-center justify-between">
    <div class="flex items-center gap-6">
      <div>
        <span class="text-gray-500 text-xs uppercase block mb-1">Airdrop Wallet</span>
        <a href="https://basescan.org/address/<%= wallet.address %>" target="_blank"
           class="text-sm font-mono text-cyan-400 hover:text-cyan-300">
          <%= wallet.address.slice(0, 6) %>...<%= wallet.address.slice(-4) %>
        </a>
      </div>
      <div>
        <span class="text-gray-500 text-xs uppercase block mb-1">ETH (Gas)</span>
        <span class="text-lg font-mono <%= wallet.needsEth ? 'text-red-400' : 'text-white' %>">
          <%= wallet.ethBalance %> ETH
        </span>
      </div>
      <div>
        <span class="text-gray-500 text-xs uppercase block mb-1"><%= wallet.tokenSymbol %> (Airdrop)</span>
        <span class="text-lg font-mono <%= wallet.needsTokens ? 'text-red-400' : 'text-emerald-400' %>">
          <%= wallet.tokenBalance %> <%= wallet.tokenSymbol %>
        </span>
      </div>
    </div>
    <% if (wallet.needsFunding) { %>
    <div class="bg-yellow-500/10 border border-yellow-500/30 rounded-lg p-3 max-w-md">
      <div class="flex items-start gap-2">
        <span class="text-yellow-400 text-lg">âš ï¸</span>
        <div>
          <p class="text-yellow-400 text-sm font-medium">Wallet Needs Funding</p>
          <button onclick="copyAddress('<%= wallet.address %>')"
                  class="mt-2 text-xs text-cyan-400 hover:text-cyan-300 underline">
            Copy Address
          </button>
        </div>
      </div>
    </div>
    <% } %>
  </div>
</div>
<% } %>

<!-- Stats Cards -->
<div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 mb-8">
  <div class="bg-dark-700 border border-dark-500 rounded-xl p-5">
    <p class="text-gray-500 text-xs font-medium uppercase tracking-wide">Total Snapshots</p>
    <p class="text-2xl font-semibold text-white mt-1"><%= totalSnapshots %></p>
  </div>
  <div class="bg-dark-700 border border-dark-500 rounded-xl p-5">
    <p class="text-gray-500 text-xs font-medium uppercase tracking-wide">Total Distributions</p>
    <p class="text-2xl font-semibold text-white mt-1"><%= totalDistributions %></p>
  </div>
  <div class="bg-dark-700 border border-dark-500 rounded-xl p-5">
    <p class="text-gray-500 text-xs font-medium uppercase tracking-wide">Pending Batches</p>
    <p class="text-2xl font-semibold text-white mt-1"><%= pendingBatches %></p>
  </div>
  <div class="bg-dark-700 border border-dark-500 rounded-xl p-5">
    <p class="text-gray-500 text-xs font-medium uppercase tracking-wide">Current Week</p>
    <p id="currentWeekDisplay" class="text-lg font-semibold text-cyan-400 mt-1 font-mono"></p>
  </div>
</div>

<!-- Week Progress & Retry Controls -->
<div class="bg-dark-700 border border-dark-500 rounded-xl mb-8">
  <div class="px-5 py-4 border-b border-dark-500 flex justify-between items-center">
    <div>
      <h2 class="text-base font-medium text-white">Week Progress & Controls</h2>
      <p class="text-gray-500 text-xs mt-0.5">Retry failed steps or manually trigger for specific week</p>
    </div>
    <div class="flex items-center gap-3">
      <label class="text-xs text-gray-500">Week:</label>
      <select id="weekSelector" onchange="loadWeekStatus()"
              class="bg-dark-600 border border-dark-500 rounded px-3 py-1.5 text-sm text-white font-mono">
        <!-- Populated by JS -->
      </select>
    </div>
  </div>

  <div class="p-5">
    <!-- 4-Step Progress -->
    <div class="flex items-center justify-between mb-6">
      <!-- Step 1: Start Snapshot -->
      <div id="step1" class="flex-1 text-center">
        <div id="step1Icon" class="w-12 h-12 mx-auto rounded-full bg-dark-600 flex items-center justify-center mb-2">
          <span class="text-gray-500">1</span>
        </div>
        <p class="text-xs text-gray-500 mb-1">Start Snapshot</p>
        <p id="step1Status" class="text-xs text-gray-600">â€”</p>
        <button id="step1Btn" onclick="retryStep('snapshot-start')"
                class="mt-2 px-3 py-1 text-xs bg-dark-600 hover:bg-cyan-500/20 text-gray-400 hover:text-cyan-400 rounded border border-dark-500 hover:border-cyan-500/50 transition-colors hidden">
          Retry
        </button>
      </div>

      <div class="w-16 h-0.5 bg-dark-600" id="line1"></div>

      <!-- Step 2: End Snapshot -->
      <div id="step2" class="flex-1 text-center">
        <div id="step2Icon" class="w-12 h-12 mx-auto rounded-full bg-dark-600 flex items-center justify-center mb-2">
          <span class="text-gray-500">2</span>
        </div>
        <p class="text-xs text-gray-500 mb-1">End Snapshot</p>
        <p id="step2Status" class="text-xs text-gray-600">â€”</p>
        <button id="step2Btn" onclick="retryStep('snapshot-end')"
                class="mt-2 px-3 py-1 text-xs bg-dark-600 hover:bg-cyan-500/20 text-gray-400 hover:text-cyan-400 rounded border border-dark-500 hover:border-cyan-500/50 transition-colors hidden">
          Retry
        </button>
      </div>

      <div class="w-16 h-0.5 bg-dark-600" id="line2"></div>

      <!-- Step 3: Calculate -->
      <div id="step3" class="flex-1 text-center">
        <div id="step3Icon" class="w-12 h-12 mx-auto rounded-full bg-dark-600 flex items-center justify-center mb-2">
          <span class="text-gray-500">3</span>
        </div>
        <p class="text-xs text-gray-500 mb-1">Calculate</p>
        <p id="step3Status" class="text-xs text-gray-600">â€”</p>
        <button id="step3Btn" onclick="retryStep('calculate')"
                class="mt-2 px-3 py-1 text-xs bg-dark-600 hover:bg-emerald-500/20 text-gray-400 hover:text-emerald-400 rounded border border-dark-500 hover:border-emerald-500/50 transition-colors hidden">
          Retry
        </button>
      </div>

      <div class="w-16 h-0.5 bg-dark-600" id="line3"></div>

      <!-- Step 4: Airdrop -->
      <div id="step4" class="flex-1 text-center">
        <div id="step4Icon" class="w-12 h-12 mx-auto rounded-full bg-dark-600 flex items-center justify-center mb-2">
          <span class="text-gray-500">4</span>
        </div>
        <p class="text-xs text-gray-500 mb-1">Airdrop</p>
        <p id="step4Status" class="text-xs text-gray-600">â€”</p>
        <button id="step4Btn" onclick="retryStep('airdrop')"
                class="mt-2 px-3 py-1 text-xs bg-dark-600 hover:bg-yellow-500/20 text-gray-400 hover:text-yellow-400 rounded border border-dark-500 hover:border-yellow-500/50 transition-colors hidden">
          Retry
        </button>
      </div>
    </div>

    <!-- Manual Trigger Buttons -->
    <div class="border-t border-dark-600 pt-4">
      <div class="flex flex-wrap gap-3 items-center justify-between">
        <span class="text-xs text-gray-500">Manual Triggers (for selected week):</span>
        <div class="flex flex-wrap gap-2">
          <button onclick="triggerStep('snapshot-start')" id="btnTriggerStart"
            class="px-3 py-1.5 bg-dark-600 hover:bg-dark-500 text-gray-300 text-xs rounded border border-dark-500 transition-colors disabled:opacity-50">
            1. Start Snapshot
          </button>
          <button onclick="triggerStep('snapshot-end')" id="btnTriggerEnd"
            class="px-3 py-1.5 bg-dark-600 hover:bg-dark-500 text-gray-300 text-xs rounded border border-dark-500 transition-colors disabled:opacity-50">
            2. End Snapshot
          </button>
          <button onclick="triggerStep('calculate')" id="btnTriggerCalc"
            class="px-3 py-1.5 bg-dark-600 hover:bg-dark-500 text-gray-300 text-xs rounded border border-dark-500 transition-colors disabled:opacity-50">
            3. Calculate
          </button>
          <button onclick="triggerStep('airdrop')" id="btnTriggerAirdrop"
            class="px-3 py-1.5 bg-dark-600 hover:bg-dark-500 text-gray-300 text-xs rounded border border-dark-500 transition-colors disabled:opacity-50">
            4. Airdrop
          </button>
        </div>
      </div>
    </div>

    <% if (isForkMode) { %>
    <!-- Dev Tools -->
    <div class="border-t border-dark-600 pt-4 mt-4">
      <div class="flex flex-wrap gap-3 items-center justify-between">
        <span class="text-xs text-gray-500 uppercase">Dev Tools:</span>
        <div class="flex flex-wrap gap-2">
          <button onclick="clearWeekData()" id="btnClearWeek"
            class="px-3 py-1.5 bg-dark-600 hover:bg-red-500/20 text-gray-400 hover:text-red-400 text-xs rounded border border-dark-500 hover:border-red-500/50 transition-colors">
            Clear Week Data
          </button>
          <button onclick="deleteDatabase()" id="btnDeleteDb"
            class="px-3 py-1.5 bg-red-600 hover:bg-red-500 text-white text-xs rounded border border-red-500 transition-colors">
            Delete Database
          </button>
        </div>
      </div>
    </div>
    <% } %>
  </div>
</div>

<!-- Job Terminal -->
<div id="jobTerminal" class="bg-dark-700 border border-dark-500 rounded-xl mb-8 hidden">
  <div class="px-5 py-4 border-b border-dark-500 flex justify-between items-center">
    <div class="flex items-center gap-3">
      <div id="jobStatusIndicator" class="w-2 h-2 bg-cyan-400 rounded-full animate-pulse"></div>
      <div>
        <h2 class="text-base font-medium text-white">Job Progress</h2>
        <p id="jobTitle" class="text-gray-500 text-xs mt-0.5">Running job...</p>
      </div>
    </div>
    <div class="flex items-center gap-4">
      <div class="text-right">
        <p id="jobProgress" class="font-mono text-sm text-cyan-400">0%</p>
      </div>
      <button onclick="closeTerminal()" class="text-gray-500 hover:text-white transition-colors">âœ•</button>
    </div>
  </div>
  <div class="px-5 py-3 bg-dark-800/50">
    <div class="w-full bg-dark-600 rounded-full h-2">
      <div id="jobProgressBar" class="bg-gradient-to-r from-cyan-500 to-emerald-500 h-2 rounded-full transition-all duration-300" style="width: 0%"></div>
    </div>
  </div>
  <div id="terminalOutput" class="bg-dark-900 font-mono text-xs overflow-auto max-h-60 p-4 space-y-1">
    <div class="text-gray-500">Waiting for job logs...</div>
  </div>
</div>

<!-- Recent Jobs -->
<div class="bg-dark-700 border border-dark-500 rounded-xl mb-8">
  <div class="px-5 py-4 border-b border-dark-500 flex justify-between items-center">
    <div>
      <h2 class="text-base font-medium text-white">Job History</h2>
      <p class="text-gray-500 text-xs mt-0.5">Persistent job logs stored in database</p>
    </div>
    <button onclick="refreshJobs()" class="text-xs text-cyan-400 hover:text-cyan-300 flex items-center gap-1">
      <span>â†»</span> Refresh
    </button>
  </div>
  <div id="recentJobsList" class="divide-y divide-dark-600 max-h-96 overflow-y-auto">
    <div class="px-5 py-8 text-center text-gray-500 text-sm">Loading...</div>
  </div>
</div>

<!-- Recent Distributions -->
<div class="bg-dark-700 border border-dark-500 rounded-xl overflow-hidden">
  <div class="px-5 py-4 border-b border-dark-500">
    <h2 class="text-base font-medium text-white">Recent Distributions</h2>
  </div>
  <div class="overflow-x-auto">
    <table class="w-full">
      <thead>
        <tr class="bg-dark-800/50">
          <th class="px-5 py-3 text-left text-xs font-medium text-gray-500 uppercase">Week</th>
          <th class="px-5 py-3 text-left text-xs font-medium text-gray-500 uppercase">Status</th>
          <th class="px-5 py-3 text-left text-xs font-medium text-gray-500 uppercase">Eligible</th>
          <th class="px-5 py-3 text-left text-xs font-medium text-gray-500 uppercase">Created</th>
          <th class="px-5 py-3 text-left text-xs font-medium text-gray-500 uppercase">Actions</th>
        </tr>
      </thead>
      <tbody class="divide-y divide-dark-600">
        <% recentDistributions.forEach(d => { %>
        <tr class="hover:bg-dark-600/30 transition-colors">
          <td class="px-5 py-3 font-mono text-sm text-white"><%= d.weekId %></td>
          <td class="px-5 py-3">
            <span class="px-2 py-0.5 text-xs rounded-full
              <%= d.status === 'completed' ? 'bg-emerald-500/20 text-emerald-400' :
                 d.status === 'failed' ? 'bg-red-500/20 text-red-400' :
                 d.status === 'ready' ? 'bg-cyan-500/20 text-cyan-400' :
                 'bg-yellow-500/20 text-yellow-400' %>">
              <%= d.status %>
            </span>
          </td>
          <td class="px-5 py-3 text-sm text-gray-300"><%= d.stats?.eligibleHolders || 0 %></td>
          <td class="px-5 py-3 text-sm text-gray-500"><%= new Date(d.createdAt).toLocaleDateString() %></td>
          <td class="px-5 py-3">
            <a href="/admin/distributions/<%= d._id %>" class="text-sm text-cyan-400 hover:text-cyan-300">View â†’</a>
          </td>
        </tr>
        <% }) %>
        <% if (recentDistributions.length === 0) { %>
        <tr>
          <td colspan="5" class="px-5 py-8 text-center text-gray-500 text-sm">No distributions yet</td>
        </tr>
        <% } %>
      </tbody>
    </table>
  </div>
</div>

<script>
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// Utilities
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

function getCurrentWeekId() {
  const now = new Date();
  const start = new Date(now.getFullYear(), 0, 1);
  const days = Math.floor((now - start) / 86400000);
  const week = Math.ceil((days + start.getDay() + 1) / 7);
  return `${now.getFullYear()}-W${week.toString().padStart(2, '0')}`;
}

function escapeHtml(text) {
  const div = document.createElement('div');
  div.textContent = text;
  return div.innerHTML;
}

function copyAddress(address) {
  navigator.clipboard.writeText(address).then(() => alert('Address copied!'));
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// Week Status & Retry
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

let selectedWeekId = getCurrentWeekId();

async function initWeekSelector() {
  const select = document.getElementById('weekSelector');
  const currentWeek = getCurrentWeekId();

  try {
    // Fetch actual weeks from database
    const res = await fetch('/admin/weeks/list');
    const data = await res.json();

    if (data.success && data.weeks && data.weeks.length > 0) {
      // Use actual weeks from database
      select.innerHTML = data.weeks.map((w, i) =>
        `<option value="${w}" ${i === 0 ? 'selected' : ''}>${w}</option>`
      ).join('');
      selectedWeekId = data.weeks[0];
    } else {
      // Fallback: generate week IDs
      const weeks = [];
      for (let i = 0; i < 5; i++) {
        const d = new Date();
        d.setDate(d.getDate() - (i * 7));
        const start = new Date(d.getFullYear(), 0, 1);
        const days = Math.floor((d - start) / 86400000);
        const week = Math.ceil((days + start.getDay() + 1) / 7);
        weeks.push(`${d.getFullYear()}-W${week.toString().padStart(2, '0')}`);
      }
      const uniqueWeeks = [...new Set(weeks)].sort().reverse();
      select.innerHTML = uniqueWeeks.map(w =>
        `<option value="${w}" ${w === currentWeek ? 'selected' : ''}>${w}</option>`
      ).join('');
    }
  } catch (e) {
    console.error('Failed to load weeks:', e);
  }

  document.getElementById('currentWeekDisplay').textContent = currentWeek;
  loadWeekStatus();
}

async function loadWeekStatus() {
  selectedWeekId = document.getElementById('weekSelector').value;

  try {
    const res = await fetch(`/admin/week/${selectedWeekId}/status`);
    const data = await res.json();

    if (data.success) {
      updateStepUI(data.status);
    }
  } catch (e) {
    console.error('Failed to load week status:', e);
  }
}

function updateStepUI(status) {
  // Step 1: Start Snapshot
  updateStep(1, status.startSnapshot);

  // Step 2: End Snapshot
  updateStep(2, status.endSnapshot);

  // Step 3: Calculate
  updateStep(3, status.calculate);

  // Step 4: Airdrop
  updateStep(4, status.airdrop);

  // Update connecting lines
  updateLine(1, status.startSnapshot?.status === 'completed');
  updateLine(2, status.endSnapshot?.status === 'completed');
  updateLine(3, status.calculate?.status === 'completed');
}

function updateStep(num, stepStatus) {
  const icon = document.getElementById(`step${num}Icon`);
  const statusEl = document.getElementById(`step${num}Status`);
  const btn = document.getElementById(`step${num}Btn`);

  if (!stepStatus || stepStatus.status === 'pending') {
    icon.innerHTML = `<span class="text-gray-500">${num}</span>`;
    icon.className = 'w-12 h-12 mx-auto rounded-full bg-dark-600 flex items-center justify-center mb-2';
    statusEl.textContent = 'Pending';
    statusEl.className = 'text-xs text-gray-600';
    btn.classList.add('hidden');
  } else if (stepStatus.status === 'completed') {
    icon.innerHTML = 'âœ“';
    icon.className = 'w-12 h-12 mx-auto rounded-full bg-emerald-500/20 text-emerald-400 flex items-center justify-center mb-2';
    statusEl.textContent = new Date(stepStatus.completedAt).toLocaleTimeString();
    statusEl.className = 'text-xs text-emerald-400';
    btn.classList.add('hidden');
  } else if (stepStatus.status === 'failed') {
    icon.innerHTML = 'âœ—';
    icon.className = 'w-12 h-12 mx-auto rounded-full bg-red-500/20 text-red-400 flex items-center justify-center mb-2';
    statusEl.textContent = 'Failed';
    statusEl.className = 'text-xs text-red-400';
    btn.classList.remove('hidden');
  } else if (stepStatus.status === 'running') {
    icon.innerHTML = '<div class="w-4 h-4 border-2 border-cyan-400 border-t-transparent rounded-full animate-spin"></div>';
    icon.className = 'w-12 h-12 mx-auto rounded-full bg-cyan-500/20 flex items-center justify-center mb-2';
    statusEl.textContent = 'Running...';
    statusEl.className = 'text-xs text-cyan-400';
    btn.classList.add('hidden');
  }
}

function updateLine(num, completed) {
  const line = document.getElementById(`line${num}`);
  if (line) {
    line.className = completed
      ? 'w-16 h-0.5 bg-emerald-500/50'
      : 'w-16 h-0.5 bg-dark-600';
  }
}

async function retryStep(step) {
  if (!confirm(`Retry ${step} for week ${selectedWeekId}?`)) return;

  try {
    const res = await fetch(`/admin/week/${selectedWeekId}/retry/${step}`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' }
    });
    const data = await res.json();

    if (data.success && data.job) {
      showTerminal(data.job.id || data.job._id, `${step} - ${selectedWeekId}`);
    } else {
      alert(data.error || 'Retry failed');
    }
  } catch (e) {
    alert('Error: ' + e.message);
  }
}

async function triggerStep(step) {
  const weekId = selectedWeekId;

  try {
    const res = await fetch(`/admin/week/${weekId}/trigger/${step}`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' }
    });
    const data = await res.json();

    if (data.success && data.job) {
      showTerminal(data.job.id || data.job._id, `${step} - ${weekId}`);
    } else {
      alert(data.error || 'Trigger failed');
    }
  } catch (e) {
    alert('Error: ' + e.message);
  }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// Terminal
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

let currentJobId = null;
let jobPollInterval = null;
let lastLogCount = 0;

function showTerminal(jobId, title) {
  currentJobId = jobId;
  lastLogCount = 0;

  document.getElementById('jobTerminal').classList.remove('hidden');
  document.getElementById('jobTitle').textContent = title;
  document.getElementById('terminalOutput').innerHTML = '<div class="text-cyan-400">â— Loading...</div>';
  document.getElementById('jobProgress').textContent = '0%';
  document.getElementById('jobProgressBar').style.width = '0%';

  if (jobPollInterval) clearInterval(jobPollInterval);
  jobPollInterval = setInterval(pollJobStatus, 1000);
  pollJobStatus();
}

function closeTerminal() {
  document.getElementById('jobTerminal').classList.add('hidden');
  if (jobPollInterval) clearInterval(jobPollInterval);
  currentJobId = null;
}

async function pollJobStatus() {
  if (!currentJobId) return;

  try {
    const res = await fetch(`/admin/jobs/${currentJobId}/logs`);
    const data = await res.json();
    if (!data.success) return;

    const job = data.job;
    const logs = data.logs || [];

    // Update progress
    if (job.progress) {
      const percent = job.progress.percentage || 0;
      document.getElementById('jobProgress').textContent = `${percent}%`;
      document.getElementById('jobProgressBar').style.width = `${percent}%`;
    }

    // Append new logs
    if (logs.length > lastLogCount) {
      const output = document.getElementById('terminalOutput');
      logs.slice(lastLogCount).forEach(log => {
        const div = document.createElement('div');
        const time = new Date(log.timestamp).toLocaleTimeString();
        const colorClass = log.level === 'error' ? 'text-red-400' :
                          log.level === 'warn' ? 'text-yellow-400' :
                          log.level === 'success' ? 'text-emerald-400' : 'text-gray-300';
        div.className = colorClass;
        div.innerHTML = `<span class="text-gray-600">[${time}]</span> ${escapeHtml(log.message)}`;
        output.appendChild(div);
      });
      output.scrollTop = output.scrollHeight;
      lastLogCount = logs.length;
    }

    // Check completion
    if (job.status === 'completed' || job.status === 'failed') {
      const indicator = document.getElementById('jobStatusIndicator');
      indicator.className = job.status === 'completed'
        ? 'w-2 h-2 bg-emerald-400 rounded-full'
        : 'w-2 h-2 bg-red-400 rounded-full';

      if (jobPollInterval) clearInterval(jobPollInterval);

      setTimeout(() => {
        loadWeekStatus();
        refreshJobs();
      }, 2000);
    }
  } catch (e) {
    console.error('Poll error:', e);
  }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// Jobs List
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

async function refreshJobs() {
  try {
    const res = await fetch('/admin/jobs/status');
    const data = await res.json();
    if (!data.success) return;

    const jobs = [...(data.activeJobs || []), ...(data.recentJobs || [])];
    const container = document.getElementById('recentJobsList');

    if (jobs.length === 0) {
      container.innerHTML = '<div class="px-5 py-8 text-center text-gray-500 text-sm">No jobs yet. Trigger a step above to create one.</div>';
      return;
    }

    // Remove duplicates by ID
    const uniqueJobs = [];
    const seenIds = new Set();
    for (const job of jobs) {
      const id = job.id || job._id || job.jobId;
      if (!seenIds.has(id)) {
        seenIds.add(id);
        uniqueJobs.push(job);
      }
    }

    container.innerHTML = uniqueJobs.slice(0, 15).map(job => {
      const statusColors = {
        pending: 'bg-gray-500/20 text-gray-400',
        queued: 'bg-gray-500/20 text-gray-400',
        running: 'bg-cyan-500/20 text-cyan-400',
        completed: 'bg-emerald-500/20 text-emerald-400',
        failed: 'bg-red-500/20 text-red-400'
      };

      const jobId = job.id || job._id || job.jobId;
      const timestamp = job.createdAt ? new Date(job.createdAt).toLocaleString() : '';
      const duration = job.completedAt && job.startedAt
        ? formatDuration(new Date(job.completedAt) - new Date(job.startedAt))
        : '';

      return `
        <div class="px-5 py-3 hover:bg-dark-600/30 transition-colors">
          <div class="flex items-center justify-between">
            <div class="flex items-center gap-3">
              <span class="px-2 py-0.5 text-xs rounded-full ${statusColors[job.status] || statusColors.pending}">${job.status}</span>
              <span class="text-sm text-white font-medium">${formatJobType(job.type)}</span>
              <span class="font-mono text-gray-400 text-xs">${job.weekId}</span>
            </div>
            <div class="flex items-center gap-3">
              ${duration ? `<span class="text-xs text-gray-500">${duration}</span>` : ''}
              <button onclick="showTerminal('${jobId}', '${job.type} - ${job.weekId}')" class="text-xs text-cyan-400 hover:text-cyan-300">View Logs</button>
            </div>
          </div>
          <div class="mt-1 flex items-center gap-2">
            <span class="text-xs text-gray-600">${timestamp}</span>
            ${job.error ? `<span class="text-xs text-red-400 truncate max-w-md">Error: ${escapeHtml(job.error.slice(0, 100))}</span>` : ''}
          </div>
        </div>
      `;
    }).join('');

    // Auto-show terminal for running jobs
    const runningJob = uniqueJobs.find(j => j.status === 'running');
    if (runningJob && !currentJobId) {
      const jobId = runningJob.id || runningJob._id || runningJob.jobId;
      showTerminal(jobId, `${runningJob.type} - ${runningJob.weekId}`);
    }
  } catch (e) {
    console.error('Failed to refresh jobs:', e);
    document.getElementById('recentJobsList').innerHTML = '<div class="px-5 py-8 text-center text-red-400 text-sm">Failed to load jobs</div>';
  }
}

function formatJobType(type) {
  const labels = {
    'snapshot-start': 'ğŸ“¸ Start Snapshot',
    'snapshot-end': 'ğŸ“¸ End Snapshot',
    'snapshot': 'ğŸ“¸ Snapshot',
    'calculate': 'ğŸ§® Calculate',
    'calculation': 'ğŸ§® Calculate',
    'airdrop': 'ğŸ’¸ Airdrop',
    'full-flow': 'ğŸ”„ Full Flow'
  };
  return labels[type] || type;
}

function formatDuration(ms) {
  if (ms < 1000) return `${ms}ms`;
  if (ms < 60000) return `${(ms / 1000).toFixed(1)}s`;
  const mins = Math.floor(ms / 60000);
  const secs = Math.floor((ms % 60000) / 1000);
  return `${mins}m ${secs}s`;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// Dev Tools
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

async function clearWeekData() {
  if (!confirm(`Clear all data for ${selectedWeekId}?`)) return;

  try {
    const res = await fetch('/admin/dev/clear-data', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ weekId: selectedWeekId })
    });
    const data = await res.json();
    if (data.success) {
      alert('Data cleared');
      location.reload();
    } else {
      alert(data.error || 'Failed');
    }
  } catch (e) {
    alert('Error: ' + e.message);
  }
}

async function deleteDatabase() {
  if (!confirm('DELETE ENTIRE DATABASE?')) return;
  if (prompt('Type DELETE to confirm:') !== 'DELETE') return;

  try {
    const res = await fetch('/admin/dev/delete-database', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' }
    });
    const data = await res.json();
    if (data.success) {
      alert('Database deleted');
      location.reload();
    }
  } catch (e) {
    alert('Error: ' + e.message);
  }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// Initialize
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

initWeekSelector();
refreshJobs();
setInterval(refreshJobs, 5000);
setInterval(loadWeekStatus, 10000);
</script>
