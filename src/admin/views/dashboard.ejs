<!-- Dashboard Header -->
<div class="mb-8">
  <h1 class="text-2xl font-semibold text-white">Dashboard</h1>
  <p class="text-gray-500 text-sm mt-1">Monitor your weekly airdrop distributions</p>
</div>

<!-- Stats Cards -->
<div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 mb-8">
  <div class="bg-dark-700 border border-dark-500 rounded-xl p-5">
    <p class="text-gray-500 text-xs font-medium uppercase tracking-wide">Total Snapshots</p>
    <p class="text-2xl font-semibold text-white mt-1"><%= totalSnapshots %></p>
  </div>

  <div class="bg-dark-700 border border-dark-500 rounded-xl p-5">
    <p class="text-gray-500 text-xs font-medium uppercase tracking-wide">Total Distributions</p>
    <p class="text-2xl font-semibold text-white mt-1"><%= totalDistributions %></p>
  </div>

  <div class="bg-dark-700 border border-dark-500 rounded-xl p-5">
    <p class="text-gray-500 text-xs font-medium uppercase tracking-wide">Pending Batches</p>
    <p class="text-2xl font-semibold text-white mt-1"><%= pendingBatches %></p>
  </div>

  <div class="bg-dark-700 border border-dark-500 rounded-xl p-5">
    <p class="text-gray-500 text-xs font-medium uppercase tracking-wide">Latest Distribution</p>
    <p class="text-lg font-semibold text-white mt-1 font-mono"><%= latestDistribution?.weekId || '—' %></p>
    <% if (latestDistribution) { %>
    <span class="inline-block mt-2 px-2 py-0.5 text-xs rounded-full
      <%= latestDistribution.status === 'completed' ? 'bg-emerald-500/20 text-emerald-400' :
         latestDistribution.status === 'failed' ? 'bg-red-500/20 text-red-400' :
         latestDistribution.status === 'ready' ? 'bg-cyan-500/20 text-cyan-400' :
         'bg-yellow-500/20 text-yellow-400' %>">
      <%= latestDistribution.status %>
    </span>
    <% } %>
  </div>
</div>

<!-- Test Triggers -->
<div class="bg-dark-700 border border-dark-500 rounded-xl mb-8">
  <div class="px-5 py-4 border-b border-dark-500 flex justify-between items-center">
    <div>
      <h2 class="text-base font-medium text-white">Manual Test Triggers</h2>
      <p class="text-gray-500 text-xs mt-0.5">Execute airdrop flow steps for testing</p>
    </div>
    <div class="text-right">
      <p class="text-gray-500 text-xs">Current Week</p>
      <p id="currentWeek" class="font-mono text-sm text-cyan-400"></p>
    </div>
  </div>
  <div class="p-5">
    <div class="flex flex-wrap gap-3 items-center">
      <button onclick="triggerSnapshot('start')" id="btnStartSnapshot"
        class="px-4 py-2 bg-dark-600 hover:bg-dark-500 text-gray-200 text-sm rounded-lg border border-dark-500 transition-colors disabled:opacity-50">
        1. Start Snapshot
      </button>
      <span class="text-dark-500">→</span>
      <button onclick="triggerSnapshot('end')" id="btnEndSnapshot"
        class="px-4 py-2 bg-dark-600 hover:bg-dark-500 text-gray-200 text-sm rounded-lg border border-dark-500 transition-colors disabled:opacity-50">
        2. End Snapshot
      </button>
      <span class="text-dark-500">→</span>
      <button onclick="triggerCalculation()" id="btnCalculate"
        class="px-4 py-2 bg-dark-600 hover:bg-dark-500 text-gray-200 text-sm rounded-lg border border-dark-500 transition-colors disabled:opacity-50">
        3. Calculate
      </button>
      <div class="border-l border-dark-500 pl-3 ml-1">
        <button onclick="triggerFullFlow()" id="btnFullFlow"
          class="px-4 py-2 bg-gradient-to-r from-cyan-500 to-emerald-500 hover:from-cyan-400 hover:to-emerald-400 text-white text-sm font-medium rounded-lg transition-all disabled:opacity-50">
          Run Full Flow
        </button>
      </div>
    </div>
    <div id="triggerResult" class="mt-4 hidden">
      <pre id="resultContent" class="p-3 rounded-lg text-xs font-mono overflow-auto max-h-48"></pre>
    </div>
  </div>
</div>

<!-- Recent Distributions -->
<div class="bg-dark-700 border border-dark-500 rounded-xl overflow-hidden">
  <div class="px-5 py-4 border-b border-dark-500">
    <h2 class="text-base font-medium text-white">Recent Distributions</h2>
  </div>
  <div class="overflow-x-auto">
    <table class="w-full">
      <thead>
        <tr class="bg-dark-800/50">
          <th class="px-5 py-3 text-left text-xs font-medium text-gray-500 uppercase">Week</th>
          <th class="px-5 py-3 text-left text-xs font-medium text-gray-500 uppercase">Status</th>
          <th class="px-5 py-3 text-left text-xs font-medium text-gray-500 uppercase">Eligible</th>
          <th class="px-5 py-3 text-left text-xs font-medium text-gray-500 uppercase">Created</th>
          <th class="px-5 py-3 text-left text-xs font-medium text-gray-500 uppercase">Actions</th>
        </tr>
      </thead>
      <tbody class="divide-y divide-dark-600">
        <% recentDistributions.forEach(d => { %>
        <tr class="hover:bg-dark-600/30 transition-colors">
          <td class="px-5 py-3 font-mono text-sm text-white"><%= d.weekId %></td>
          <td class="px-5 py-3">
            <span class="px-2 py-0.5 text-xs rounded-full
              <%= d.status === 'completed' ? 'bg-emerald-500/20 text-emerald-400' :
                 d.status === 'failed' ? 'bg-red-500/20 text-red-400' :
                 d.status === 'ready' ? 'bg-cyan-500/20 text-cyan-400' :
                 'bg-yellow-500/20 text-yellow-400' %>">
              <%= d.status %>
            </span>
          </td>
          <td class="px-5 py-3 text-sm text-gray-300"><%= d.stats?.eligibleHolders || 0 %></td>
          <td class="px-5 py-3 text-sm text-gray-500"><%= new Date(d.createdAt).toLocaleDateString() %></td>
          <td class="px-5 py-3">
            <a href="/admin/distributions/<%= d._id %>" class="text-sm text-cyan-400 hover:text-cyan-300">View →</a>
          </td>
        </tr>
        <% }) %>
        <% if (recentDistributions.length === 0) { %>
        <tr>
          <td colspan="5" class="px-5 py-8 text-center text-gray-500 text-sm">No distributions yet</td>
        </tr>
        <% } %>
      </tbody>
    </table>
  </div>
</div>

<script>
  function getCurrentWeekId() {
    const now = new Date();
    const start = new Date(now.getFullYear(), 0, 1);
    const days = Math.floor((now - start) / 86400000);
    const week = Math.ceil((days + start.getDay() + 1) / 7);
    return `${now.getFullYear()}-W${week.toString().padStart(2, '0')}`;
  }
  document.getElementById('currentWeek').textContent = getCurrentWeekId();

  function showResult(success, data) {
    const el = document.getElementById('triggerResult');
    const content = document.getElementById('resultContent');
    el.classList.remove('hidden');
    content.className = `p-3 rounded-lg text-xs font-mono overflow-auto max-h-48 ${success ? 'bg-emerald-500/10 text-emerald-400 border border-emerald-500/20' : 'bg-red-500/10 text-red-400 border border-red-500/20'}`;
    content.textContent = JSON.stringify(data, null, 2);
  }

  function setLoading(id, loading) {
    const btn = document.getElementById(id);
    btn.disabled = loading;
    if (loading) { btn.dataset.text = btn.textContent; btn.textContent = 'Processing...'; }
    else if (btn.dataset.text) btn.textContent = btn.dataset.text;
  }

  async function triggerSnapshot(type) {
    const id = type === 'start' ? 'btnStartSnapshot' : 'btnEndSnapshot';
    setLoading(id, true);
    try {
      const res = await fetch('/admin/trigger/snapshot', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ type }) });
      const data = await res.json();
      showResult(data.success, data);
      if (data.success) setTimeout(() => location.reload(), 1500);
    } catch (e) { showResult(false, { error: e.message }); }
    finally { setLoading(id, false); }
  }

  async function triggerCalculation() {
    setLoading('btnCalculate', true);
    try {
      const res = await fetch('/admin/trigger/calculate', { method: 'POST', headers: { 'Content-Type': 'application/json' } });
      const data = await res.json();
      showResult(data.success, data);
      if (data.success) setTimeout(() => location.reload(), 1500);
    } catch (e) { showResult(false, { error: e.message }); }
    finally { setLoading('btnCalculate', false); }
  }

  async function triggerFullFlow() {
    setLoading('btnFullFlow', true);
    try {
      const res = await fetch('/admin/trigger/full-flow', { method: 'POST', headers: { 'Content-Type': 'application/json' } });
      const data = await res.json();
      showResult(data.success, data);
      if (data.success) setTimeout(() => location.reload(), 1500);
    } catch (e) { showResult(false, { error: e.message }); }
    finally { setLoading('btnFullFlow', false); }
  }
</script>
